<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sumato | Monitoring Hub</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root { 
            --sumato-blue: #0B2A3B; 
            --sumato-green: #7AAB51; 
            --bg-tech: #0f172a; 
            --danger: #ef4444; 
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-tech); color: #1e293b; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        
        .header { background: rgba(255, 255, 255, 0.05); padding: 20px; border-radius: 12px; margin-bottom: 25px; border-left: 8px solid var(--sumato-green); }
        .header h1 { color: var(--sumato-green); font-size: 1.8rem; font-weight: 800; }
        .header h1 span { color: white; font-weight: 400; }

        /* TARJETAS DE INCIDENCIA */
        .incident-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 15px; }
        .card { background: white; border-radius: 10px; padding: 18px; border-left: 6px solid #ccc; position: relative; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .card-main-id { font-size: 1.5rem; font-weight: 800; color: var(--sumato-blue); }
        .card-date { font-size: 0.85rem; color: #64748b; float: right; }
        .card-sub-id { font-size: 0.8rem; color: #64748b; font-weight: 700; display: block; margin-top: 5px; background: #f1f5f9; padding: 2px 8px; border-radius: 4px; width: fit-content; }
        
        /* COLORES POR TIPO */
        .tipo-red { border-left-color: var(--sumato-green); } /* Problema de Red = Verde Sumato */
        .tipo-alerta { border-left-color: #f59e0b; }

        .info-row { margin-top: 10px; font-size: 0.9rem; }
        .info-label { color: #94a3b8; font-weight: 600; text-transform: uppercase; font-size: 0.7rem; }

        .btn-group { display: flex; gap: 8px; margin-top: 18px; }
        .btn { border: none; padding: 10px; border-radius: 6px; color: white; cursor: pointer; font-weight: 700; font-size: 0.75rem; flex: 1; transition: 0.2s; }
        .btn-res { background: var(--sumato-green); }
        .btn-edi { background: #3b82f6; }
        .btn-del { background: #94a3b8; }
        .btn:hover { transform: translateY(-2px); filter: brightness(1.1); }
        
        #loading { color: white; text-align: center; font-size: 1.2rem; margin-top: 50px; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>SUMATO | <span>MONITORING HUB</span></h1>
    </div>

    <div id="loading">Cargando incidencias activas...</div>
    <div class="incident-grid" id="mainGrid"></div>
</div>

<script>
    // URL DE TU SCRIPT YA VINCULADA
    const API_URL = "https://script.google.com/macros/s/AKfycbwd2gD_2-9fMzD7wMjL9Om2g-sLlarr4OaMGPMO-eVllZqT_0DQbCrDgo5OsBXWluMdIA/exec";

    async function loadData() {
        try {
            const response = await fetch(API_URL);
            const data = await response.json();
            renderIncidencias(data.incidencias);
            document.getElementById('loading').style.display = 'none';
        } catch (error) {
            document.getElementById('loading').innerText = 'Error al cargar datos. Verifica la conexión.';
        }
    }

    function renderIncidencias(incs) {
        const grid = document.getElementById('mainGrid');
        grid.innerHTML = '';
        
        // Filtramos solo las NO resueltas
        const pendientes = incs.filter(i => i.Resuelto !== "Si");

        pendientes.reverse().forEach(inc => {
            const isRed = inc.TipoAnomalia === "Problema de Red";
            const card = document.createElement('div');
            card.className = `card ${isRed ? 'tipo-red' : 'tipo-alerta'}`;
            
            card.innerHTML = `
                <span class="card-date">${inc.Fecha.split(' ')[0]}</span>
                <div class="card-main-id">${inc.DeviceId}</div>
                <span class="card-sub-id">${inc.IdIncidencia}</span>
                
                <div class="info-row">
                    <div class="info-label">Tipo de Anomalía</div>
                    <div style="font-weight:700;">${inc.TipoAnomalia}</div>
                </div>

                <div class="info-row">
                    <div class="info-label">Ubicación</div>
                    <div>${inc.Tienda} - ${inc.Zona}</div>
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-res" onclick="marcarResuelta('${inc.IdIncidencia}')">Marcar Resuelta</button>
                    <button class="btn btn-del" onclick="alert('Función en desarrollo')">Eliminar</button>
                </div>
            `;
            grid.appendChild(card);
        });
    }

    async function marcarResuelta(id) {
        if(!confirm("¿Confirmas que la incidencia " + id + " ha sido resuelta?")) return;
        
        // Efecto visual de carga
        event.target.innerText = "Procesando...";
        event.target.disabled = true;

        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                mode: 'no-cors', // Necesario para Google Script
                body: JSON.stringify({ 
                    action: 'marcar_resuelta', 
                    idIncidencia: id 
                })
            });
            
            alert("¡Incidencia marcada como resuelta!");
            loadData(); // Recargar la lista
        } catch (error) {
            alert("Error al actualizar. Intenta de nuevo.");
            loadData();
        }
    }

    // Carga inicial
    loadData();
    
    // Auto-refresco cada 5 minutos
    setInterval(loadData, 300000);
</script>
</body>
</html>
