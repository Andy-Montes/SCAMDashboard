<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C√°maras Sodimac</title>
        <script>
                    // Protecci√≥n con contrase√±a (solo una vez por sesi√≥n)
                    var claveCorrecta = "deploy2026";

                    function pedirClave() {
                        // Verificar si ya ingres√≥ la contrase√±a en esta sesi√≥n
                        if (sessionStorage.getItem('auth') === 'true') {
                            return; // Ya est√° autenticado
                        }

                        var intentos = 0;
                        
                        function intentarAcceso() {
                            var password = prompt("üîí Ingresa la contrase√±a para acceder:");

                            if (password === null) {
                                alert("Acceso denegado");
                                window.location.href = "about:blank";
                                return;
                            }

                            if (password !== claveCorrecta) {
                                intentos++;
                                if (intentos >= 3) {
                                    alert("‚ùå Demasiados intentos fallidos. Acceso bloqueado.");
                                    window.location.href = "about:blank";
                                } else {
                                    alert("‚ùå Contrase√±a incorrecta. Intento " + intentos + " de 3");
                                    intentarAcceso();
                                }
                            } else {
                                // Contrase√±a correcta - guardar en sessionStorage
                                sessionStorage.setItem('auth', 'true');
                            }
                        }
                        
                        intentarAcceso();
                    }

                    pedirClave();
                </script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #0B2A3B; color: #2d3748; min-height: 100vh; padding: 20px; }
        
        /* Header */
        .header { text-align: center; margin-bottom: 30px; }
        .header h1 { color: #7AAB51; font-size: 2.2em; margin-bottom: 5px; }
        .header .subtitle { color: #a0aec0; font-size: 0.95em; }
        
        /* KPIS */
        .kpis { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .kpi-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); text-align: center; }
        .kpi-label { font-size: 0.85em; color: #718096; margin-bottom: 8px; font-weight: 500; }
        .kpi-value { font-size: 2em; font-weight: 700; margin-bottom: 5px; }
        .kpi-subtitle { font-size: 0.8em; color: #a0aec0; }
        .kpi-green { color: #7AAB51; }
        .kpi-red { color: #e53e3e; }
        .kpi-orange { color: #dd6b20; }
        .kpi-blue { color: #0B2A3B; }
        .kpi-purple { color: #805ad5; }
        
        /* Tabs */
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .view-tab { background: white; color: #4a5568; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s; }
        .view-tab:hover { background: #f7fafc; }
        .view-tab.active { background: #7AAB51; color: white; }
        
        /* Filters */
        .filters { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .filters-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .filter-group label { display: block; font-size: 0.85em; color: #4a5568; margin-bottom: 6px; font-weight: 600; }
        .filter-group input,
        .filter-group select { width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 0.95em; }
        
        /* Add Incident Section */
        .add-incident-section { background: #FFF9E6; border: 3px solid #FFD700; padding: 25px; border-radius: 12px; margin-bottom: 30px; box-shadow: 0 4px 12px rgba(255,215,0,0.2); }
        .add-incident-section h3 { color: #0B2A3B; margin-bottom: 20px; font-size: 1.3em; }
        .add-incident-section h3::before { content: '‚ö†Ô∏è '; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .form-group label { display: block; font-size: 0.85em; color: #4a5568; margin-bottom: 6px; font-weight: 600; }
        .form-group input,
        .form-group select,
        .form-group textarea { width: 100%; padding: 10px; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 0.95em; font-family: inherit; }
        .form-group textarea { min-height: 80px; resize: vertical; }
        .btn-submit { background: #7AAB51; color: white; padding: 12px 30px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1em; margin-top: 10px; }
        .btn-submit:hover { background: #6a9b41; }
        
        /* Views */
        .view-container { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        
        /* Incident Cards */
        .incidents-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; }
        .incident-card { padding: 15px; border-radius: 10px; border-left: 5px solid; box-shadow: 0 2px 6px rgba(0,0,0,0.1); transition: transform 0.2s; }
        .incident-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .incident-header { font-weight: 700; font-size: 0.95em; color: #2d3748; margin-bottom: 8px; }
        .incident-id { font-size: 0.75em; color: #718096; margin-bottom: 6px; font-family: monospace; font-weight: 600; }
        .incident-type { font-size: 0.9em; color: #4a5568; margin-bottom: 10px; font-weight: 500; }
        .incident-meta { font-size: 0.8em; color: #718096; margin-bottom: 12px; }
        .incident-actions { display: flex; gap: 8px; flex-wrap: wrap; }
        .incident-actions button { padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.85em; font-weight: 600; transition: all 0.2s; }
        .btn-resolve { background: #7AAB51; color: white; }
        .btn-resolve:hover { background: #6a9b41; }
        .btn-edit { background: #3182ce; color: white; }
        .btn-edit:hover { background: #2c5aa0; }
        .btn-delete { background: #e53e3e; color: white; }
        .btn-delete:hover { background: #c53030; }
        .resolved-badge { background: #805ad5; color: white; padding: 6px 12px; border-radius: 6px; font-size: 0.85em; font-weight: 600; }
        
        /* Tipo colors */
        .tipo-desalineada { background: #fefcbf; border-left-color: #d69e2e; }
        .tipo-configuracion { background: #fed7d7; border-left-color: #e53e3e; }
        .tipo-obstruccion { background: #bee3f8; border-left-color: #3182ce; }
        .tipo-imagen { background: #fbb6ce; border-left-color: #d53f8c; }
        .tipo-acceso { background: #fecaca; border-left-color: #dc2626; }
        .tipo-red { background: #d1fae5; border-left-color: #10b981; }
        .tipo-otro { background: #e2e8f0; border-left-color: #718096; }
        
        /* Store summary */
        .stores-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; }
        .store-card { background: white; border: 2px solid #e2e8f0; padding: 15px; border-radius: 10px; }
        .store-card.status-ok { border-left: 5px solid #7AAB51; background: #f0fdf4; }
        .store-card.status-alert { border-left: 5px solid #f59e0b; background: #fffbeb; }
        .store-card.status-critical { border-left: 5px solid #e53e3e; background: #fef2f2; }
        .store-card.status-none { border-left: 5px solid #10b981; background: #ecfdf5; }
        .store-name { font-weight: 700; color: #2d3748; margin-bottom: 10px; font-size: 1.05em; }
        .store-badge { display: inline-block; padding: 4px 10px; border-radius: 6px; font-size: 0.75em; font-weight: 600; margin-bottom: 10px; }
        .badge-ok { background: #7AAB51; color: white; }
        .badge-alert { background: #f59e0b; color: white; }
        .badge-critical { background: #e53e3e; color: white; }
        .badge-none { background: #10b981; color: white; }
        .store-stats { font-size: 0.85em; color: #4a5568; }
        .store-stats-row { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .stat-label { color: #718096; }
        .stat-value { font-weight: 600; }
        .stat-active { color: #7AAB51; }
        .stat-inactive { color: #f59e0b; }
        .stat-incidents { color: #e53e3e; }
        
        /* Modal */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); }
        .modal-content { background: white; margin: 5% auto; padding: 30px; border-radius: 12px; width: 90%; max-width: 500px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .modal-header { font-size: 1.4em; font-weight: 700; color: #2d3748; margin-bottom: 20px; }
        .modal-close { float: right; font-size: 28px; font-weight: bold; color: #a0aec0; cursor: pointer; line-height: 20px; }
        .modal-close:hover { color: #2d3748; }
        .modal-form { display: flex; flex-direction: column; gap: 15px; }
        .modal-buttons { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
        .btn-cancel { background: #cbd5e0; color: #2d3748; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; }
        .btn-cancel:hover { background: #a0aec0; }
        .btn-save { background: #3182ce; color: white; padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; }
        .btn-save:hover { background: #2c5aa0; }
        
        /* Loading */
        .loading { text-align: center; padding: 40px; color: #7AAB51; font-size: 1.1em; }
    </style>
</head>
<body>
    <div class="header">
        <h1>üé• Dashboard C√°maras Sodimac</h1>
        <div class="subtitle" id="lastUpdate">Cargando...</div>
    </div>
    
    <div class="kpis">
        <div class="kpi-card"><div class="kpi-label">Total C√°maras</div><div class="kpi-value kpi-blue" id="kpiTotalCameras">--</div><div class="kpi-subtitle" id="kpiActiveInactive">--</div></div>
        <div class="kpi-card"><div class="kpi-label">C√°maras Activas</div><div class="kpi-value kpi-green" id="kpiActiveCameras">--</div><div class="kpi-subtitle">Operativas</div></div>
        <div class="kpi-card"><div class="kpi-label">C√°maras Inactivas</div><div class="kpi-value kpi-orange" id="kpiInactiveCameras">--</div><div class="kpi-subtitle">Requieren atenci√≥n</div></div>
        <div class="kpi-card"><div class="kpi-label">Incidencias Activas</div><div class="kpi-value kpi-red" id="kpiIncidentsActive">--</div><div class="kpi-subtitle" id="kpiByType">--</div></div>
        <div class="kpi-card"><div class="kpi-label">Incidencias Resueltas</div><div class="kpi-value kpi-purple" id="kpiIncidentsResolved">--</div><div class="kpi-subtitle" id="kpiIncidentsTotal">--</div></div>
    </div>
    
    <div class="add-incident-section">
        <h3>Agregar Nueva Incidencia</h3>
        <form id="addIncidentForm" class="form-grid">
            <div class="form-group">
                <label>DeviceId</label>
                <input type="number" id="newDeviceId" required placeholder="Ej: 23">
            </div>
            <div class="form-group">
                <label>Tipo Anomal√≠a</label>
                <select id="newTipoAnomalia" required>
                    <option value="">Seleccione...</option>
                    <option value="C√°mara desalineada / mal posicionada">C√°mara desalineada / mal posicionada</option>
                    <option value="Error de configuraci√≥n">Error de configuraci√≥n</option>
                    <option value="Obstrucci√≥n de c√°mara">Obstrucci√≥n de c√°mara</option>
                    <option value="Problema de imagen">Problema de imagen</option>
                    <option value="Sin acceso a Camara">Sin acceso a Camara</option>
                    <option value="Problema de Red">Problema de Red</option>
                </select>
            </div>
            <div class="form-group">
                <label>Estado C√°mara</label>
                <select id="newEstadoCamara" required>
                    <option value="">Seleccione...</option>
                    <option value="Activa">Activa</option>
                    <option value="Inactiva">Inactiva</option>
                </select>
            </div>
            <div class="form-group" style="grid-column: 1 / -1;">
                <label>Descripci√≥n</label>
                <textarea id="newDescripcion" placeholder="Descripci√≥n detallada de la anomal√≠a"></textarea>
            </div>
            <button type="submit" class="btn-submit">‚ûï Agregar Incidencia</button>
        </form>
    </div>
    
    <div class="tabs">
        <button class="view-tab active" id="tabResumen">üìä Resumen por Tienda</button>
        <button class="view-tab" id="tabAgrupada">üìã Vista Agrupada</button>
    </div>
    
    <div class="filters">
        <div class="filters-grid">
            <div class="filter-group">
                <label>üîç Buscar</label>
                <input type="text" id="searchInput" placeholder="Device, tienda, zona, IP...">
            </div>
            <div class="filter-group">
                <label>üè∑Ô∏è Tipo Anomal√≠a</label>
                <select id="filterType">
                    <option value="">Todas</option>
                </select>
            </div>
            <div class="filter-group">
                <label>üìπ Estado C√°mara</label>
                <select id="filterCameraStatus">
                    <option value="">Todos</option>
                    <option value="Activa">Activa</option>
                    <option value="Inactiva">Inactiva</option>
                </select>
            </div>
            <div class="filter-group">
                <label>‚úÖ Estado Incidencia</label>
                <select id="filterResolved">
                    <option value="">Todas</option>
                    <option value="No">Pendientes</option>
                    <option value="Si">Resueltas</option>
                </select>
            </div>
        </div>
    </div>
    
    <div id="resumenView" class="view-container"></div>
    <div id="agrupadaView" class="view-container" style="display:none;"></div>
    
    <!-- Modal Editar -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="modal-close">&times;</span>
            <h2 class="modal-header">‚úèÔ∏è Editar Incidencia</h2>
            <div class="modal-form">
                <div class="form-group">
                    <label>Tipo Anomal√≠a</label>
                    <select id="editTipoAnomalia">
                        <option value="C√°mara desalineada / mal posicionada">C√°mara desalineada / mal posicionada</option>
                        <option value="Error de configuraci√≥n">Error de configuraci√≥n</option>
                        <option value="Obstrucci√≥n de c√°mara">Obstrucci√≥n de c√°mara</option>
                        <option value="Problema de imagen">Problema de imagen</option>
                        <option value="Sin acceso a Camara">Sin acceso a Camara</option>
                        <option value="Problema de Red">Problema de Red</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Estado C√°mara</label>
                    <select id="editEstadoCamara">
                        <option value="Activa">Activa</option>
                        <option value="Inactiva">Inactiva</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Descripci√≥n</label>
                    <textarea id="editDescripcion"></textarea>
                </div>
            </div>
            <div class="modal-buttons">
                <button class="btn-cancel" onclick="closeEditModal()">Cancelar</button>
                <button class="btn-save" onclick="saveEdit()">Guardar</button>
            </div>
        </div>
    </div>
    
    <script>
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyqO9pHqEBTmjEpXA1OVeSKO8UdxReWsb20X8wT6elaR6-c4vmwjk7NHJ6Krn6t9UYUgQ/exec';
        
        let allDevices = [];
        let allIncidents = [];
        let currentView = 'resumen';
        let currentEditID = null;
        
        async function loadData() {
            try {
                const response = await fetch(APPS_SCRIPT_URL);
                const data = await response.json();
                
                if (data.status === 'success') {
                    allDevices = data.devices || [];
                    allIncidents = data.incidencias || [];
                    
                    document.getElementById('lastUpdate').textContent = `√öltima actualizaci√≥n: ${new Date().toLocaleString('es-CL')}`;
                    
                    calculateKPIs();
                    populateFilters();
                    applyFilters();
                } else {
                    alert('Error cargando datos: ' + (data.error || 'Error desconocido'));
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error conectando con Google Sheets');
            }
        }
        
        function calculateKPIs() {
            const totalCameras = allDevices.length;
            const activeCameras = allDevices.filter(d => d.Active === true || d.Active === 'TRUE').length;
            const inactiveCameras = totalCameras - activeCameras;
            
            const activeIncidents = allIncidents.filter(i => !i['Resuelto? Si/N0'] || i['Resuelto? Si/N0'] === 'No').length;
            const resolvedIncidents = allIncidents.filter(i => i['Resuelto? Si/N0'] === 'Si').length;
            
            document.getElementById('kpiTotalCameras').textContent = totalCameras;
            document.getElementById('kpiActiveInactive').textContent = `${activeCameras} activas ‚Ä¢ ${inactiveCameras} inactivas`;
            document.getElementById('kpiActiveCameras').textContent = activeCameras;
            document.getElementById('kpiInactiveCameras').textContent = inactiveCameras;
            document.getElementById('kpiIncidentsActive').textContent = activeIncidents;
            document.getElementById('kpiIncidentsResolved').textContent = resolvedIncidents;
            document.getElementById('kpiIncidentsTotal').textContent = `de ${allIncidents.length} totales`;
        }
        
        function populateFilters() {
            const types = [...new Set(allIncidents.map(i => i['Tipo Anomal√≠a'] || 'Sin tipo'))].sort();
            const filterType = document.getElementById('filterType');
            filterType.innerHTML = '<option value="">Todas</option>';
            types.forEach(t => {
                const opt = document.createElement('option');
                opt.value = t;
                opt.textContent = t;
                filterType.appendChild(opt);
            });
        }
        
        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const filterType = document.getElementById('filterType').value;
            const filterCameraStatus = document.getElementById('filterCameraStatus').value;
            const filterResolved = document.getElementById('filterResolved').value;
            
            let filtered = allIncidents.filter(inc => {
                const searchMatch = !searchTerm || 
                    String(inc.DeviceId || '').includes(searchTerm) ||
                    String(inc.Tienda || '').toLowerCase().includes(searchTerm) ||
                    String(inc.PhysicalZoneId || '').toLowerCase().includes(searchTerm) ||
                    String(inc.IP || '').includes(searchTerm);
                
                const typeMatch = !filterType || inc['Tipo Anomal√≠a'] === filterType;
                const statusMatch = !filterCameraStatus || inc.Estado === filterCameraStatus;
                const resolvedMatch = !filterResolved || inc['Resuelto? Si/N0'] === filterResolved;
                
                return searchMatch && typeMatch && statusMatch && resolvedMatch;
            });
            
            if (currentView === 'resumen') {
                renderResumenView(filtered);
            } else {
                renderAgrupadaView(filtered);
            }
        }
        
        function renderResumenView(incidents) {
            const stores = [...new Set(allDevices.map(d => d.StoreName))].sort();
            const container = document.getElementById('resumenView');
            
            let html = '<h2 style="margin-bottom:20px; color:#2d3748;">Resumen Tiendas (' + stores.length + ')</h2>';
            html += '<div class="stores-grid">';
            
            stores.forEach(storeName => {
                const storeDevices = allDevices.filter(d => d.StoreName === storeName);
                const totalCams = storeDevices.length;
                const activeCams = storeDevices.filter(d => d.Active === true || d.Active === 'TRUE').length;
                const inactiveCams = totalCams - activeCams;
                
                const storeIncidents = incidents.filter(i => i.Tienda === storeName && (!i['Resuelto? Si/N0'] || i['Resuelto? Si/N0'] === 'No'));
                const incCount = storeIncidents.length;
                
                let statusClass = 'status-none';
                let badgeClass = 'badge-none';
                let badgeText = 'SIN INC';
                
                if (incCount > 0) {
                    if (incCount >= 10) {
                        statusClass = 'status-critical';
                        badgeClass = 'badge-critical';
                        badgeText = 'CR√çTICO';
                    } else if (incCount >= 5) {
                        statusClass = 'status-alert';
                        badgeClass = 'badge-alert';
                        badgeText = 'ALERTA';
                    } else {
                        statusClass = 'status-ok';
                        badgeClass = 'badge-ok';
                        badgeText = 'OK';
                    }
                }
                
                html += `
                    <div class="store-card ${statusClass}">
                        <div class="store-name">${storeName}</div>
                        <div class="store-badge ${badgeClass}">${badgeText}</div>
                        <div class="store-stats">
                            <div class="store-stats-row">
                                <span class="stat-label">Total:</span>
                                <span class="stat-value">${totalCams}</span>
                            </div>
                            <div class="store-stats-row">
                                <span class="stat-label">Activas:</span>
                                <span class="stat-value stat-active">${activeCams}</span>
                            </div>
                            <div class="store-stats-row">
                                <span class="stat-label">Inactivas:</span>
                                <span class="stat-value stat-inactive">${inactiveCams}</span>
                            </div>
                            <div class="store-stats-row">
                                <span class="stat-label">Inc:</span>
                                <span class="stat-value stat-incidents">${incCount}</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        function renderAgrupadaView(incidents) {
            const container = document.getElementById('agrupadaView');
            
            if (incidents.length === 0) {
                container.innerHTML = '<p style="text-align:center; color:#a0aec0; padding:40px;">No hay incidencias que mostrar</p>';
                return;
            }
            
            let html = '<h2 style="margin-bottom:20px; color:#2d3748;">Incidencias (' + incidents.length + ')</h2>';
            html += '<div class="incidents-grid">';
            
            incidents.forEach(inc => {
                const card = createCard(inc);
                html += card.outerHTML;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }
        
        function createCard(inc) {
            const tipo = inc['Tipo Anomal√≠a'] || 'Sin tipo';
            const resolved = inc['Resuelto? Si/N0'] === 'Si';
            const cls = getTipoClass(tipo);
            const idIncidencia = inc.ID || 'SIN-ID';
            
            const card = document.createElement('div');
            card.className = 'incident-card ' + cls;
            card.innerHTML = `
                <div class="incident-id">ID: ${idIncidencia}</div>
                <div class="incident-header">${inc.Tienda} ‚Ä¢ Device ${inc.DeviceId}</div>
                <div class="incident-type">${tipo}</div>
                <div class="incident-meta">${inc.PhysicalZoneId || 'N/A'} ‚Ä¢ ${inc.IP || 'N/A'}</div>
                <div class="incident-actions">
                    ${resolved ? '<span class="resolved-badge">‚úÖ RESUELTA</span>' : `
                        <button class="btn-resolve" onclick="resolveIncident('${idIncidencia}')">Resolver</button>
                        <button class="btn-edit" onclick="editIncident('${idIncidencia}','${tipo}','${inc.Estado || ''}','${(inc.Descripci√≥n || '').replace(/'/g, "\\'")}')">Editar</button>
                        <button class="btn-delete" onclick="deleteIncident('${idIncidencia}')">Eliminar</button>
                    `}
                </div>
            `;
            return card;
        }
        
        function getTipoClass(t) {
            const tl = (t || '').toLowerCase();
            
            if (tl.includes('desalineada') || tl.includes('mal posicionada')) {
                return 'tipo-desalineada';
            }
            
            if (tl.includes('error de configuraci√≥n') || tl.includes('error de configuracion')) {
                return 'tipo-configuracion';
            }
            
            if (tl.includes('obstrucci√≥n') || tl.includes('obstruccion')) {
                return 'tipo-obstruccion';
            }
            
            if (tl.includes('problema de imagen')) {
                return 'tipo-imagen';
            }
            
            if (tl.includes('sin acceso a camara') || tl.includes('sin acceso a c√°mara')) {
                return 'tipo-acceso';
            }
            
            if (tl.includes('problema de red')) {
                return 'tipo-red';
            }
            
            return 'tipo-otro';
        }
        
        function setupEvents() {
            document.getElementById('searchInput').addEventListener('input', applyFilters);
            document.getElementById('filterType').addEventListener('change', applyFilters);
            document.getElementById('filterCameraStatus').addEventListener('change', applyFilters);
            document.getElementById('filterResolved').addEventListener('change', applyFilters);
            
            document.getElementById('tabResumen').addEventListener('click', () => {
                currentView = 'resumen';
                document.querySelectorAll('.view-tab').forEach(t => t.classList.remove('active'));
                document.getElementById('tabResumen').classList.add('active');
                document.getElementById('resumenView').style.display = 'block';
                document.getElementById('agrupadaView').style.display = 'none';
                applyFilters();
            });
            
            document.getElementById('tabAgrupada').addEventListener('click', () => {
                currentView = 'agrupada';
                document.querySelectorAll('.view-tab').forEach(t => t.classList.remove('active'));
                document.getElementById('tabAgrupada').classList.add('active');
                document.getElementById('resumenView').style.display = 'none';
                document.getElementById('agrupadaView').style.display = 'block';
                applyFilters();
            });
            
            document.getElementById('addIncidentForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await addIncident();
            });
            
            document.querySelector('.modal-close').addEventListener('click', closeEditModal);
            window.addEventListener('click', (e) => {
                if (e.target.id === 'editModal') closeEditModal();
            });
        }
        
        async function addIncident() {
            const deviceId = document.getElementById('newDeviceId').value;
            const tipoAnomalia = document.getElementById('newTipoAnomalia').value;
            const estadoCamara = document.getElementById('newEstadoCamara').value;
            const descripcion = document.getElementById('newDescripcion').value;
            
            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'agregar_incidencia',
                        deviceId: deviceId,
                        tipoAnomalia: tipoAnomalia,
                        estadoCamara: estadoCamara,
                        descripcion: descripcion
                    })
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    alert('‚úÖ Incidencia agregada con ID: ' + result.id);
                    document.getElementById('addIncidentForm').reset();
                    await loadData();
                } else {
                    alert('‚ùå Error: ' + result.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå Error agregando incidencia');
            }
        }
        
        async function resolveIncident(idIncidencia) {
            if (!confirm('¬øMarcar esta incidencia como resuelta?')) return;
            
            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'marcar_resuelta',
                        idIncidencia: idIncidencia
                    })
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    alert('‚úÖ Incidencia marcada como resuelta');
                    await loadData();
                } else {
                    alert('‚ùå Error: ' + result.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå Error procesando solicitud');
            }
        }
        
        function editIncident(idIncidencia, tipo, estado, desc) {
            currentEditID = idIncidencia;
            document.getElementById('editTipoAnomalia').value = tipo;
            document.getElementById('editEstadoCamara').value = estado;
            document.getElementById('editDescripcion').value = desc;
            document.getElementById('editModal').style.display = 'block';
        }
        
        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
            currentEditID = null;
        }
        
        async function saveEdit() {
            if (!currentEditID) return;
            
            const tipoAnomalia = document.getElementById('editTipoAnomalia').value;
            const estadoCamara = document.getElementById('editEstadoCamara').value;
            const descripcion = document.getElementById('editDescripcion').value;
            
            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'editar_incidencia',
                        idIncidencia: currentEditID,
                        tipoAnomalia: tipoAnomalia,
                        estadoCamara: estadoCamara,
                        descripcion: descripcion
                    })
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    alert('‚úÖ Incidencia editada correctamente');
                    closeEditModal();
                    await loadData();
                } else {
                    alert('‚ùå Error: ' + result.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå Error editando incidencia');
            }
        }
        
        async function deleteIncident(idIncidencia) {
            if (!confirm('‚ö†Ô∏è ¬øEliminar permanentemente esta incidencia?\n\nEsta acci√≥n no se puede deshacer.')) return;
            
            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'eliminar_incidencia',
                        idIncidencia: idIncidencia
                    })
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    alert('‚úÖ Incidencia eliminada');
                    await loadData();
                } else {
                    alert('‚ùå Error: ' + result.error);
                }
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå Error eliminando incidencia');
            }
        }
        
        // Inicializar
        window.addEventListener('DOMContentLoaded', () => {
            setupEvents();
            loadData();
        });
    </script>
</body>
</html>
